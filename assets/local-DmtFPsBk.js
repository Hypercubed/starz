import{j as d,n as g,G as E,r as p,c as h,M as A,k as S,l as m,B as y,d as P,m as M,o as I,p as o}from"./manager-MN-hWKbU.js";const f=["#c0392b","#f1c40f","#9b59b6","#00b386","#cc6600","#0a4c8c","#e74c3c","#f39c12","#8e44ad","#27ae60","#d35400","#2980b9"];function v(n){const t=f.filter(e=>!n.includes(e));return t.length===0?_():t[Math.floor(Math.random()*t.length)]}function _(){const n="0123456789ABCDEF";let t="#";for(let e=0;e<6;e++)t+=n[Math.floor(Math.random()*16)];return t}const L="ABCDEFGHJKLMNPQRSTUVWXYZ234567",G=()=>g(5),u=d(L,15),N=()=>({PLAYER_JOINED:o(),PLAYER_REMOVED:o(),ADD_MESSAGE:o(),CLEAR_MESSAGES:o(),TRACK:o()});class R extends E{constructor(){super(),this.name="LocalGameManager",this.addEvents(N())}getPlayer(){return this.thisPlayer}isMultiplayer(){return!1}mount(t){this.appRoot=t,this.appRoot.gameManager=this,this.#t()}async connect(){this.gameStop(),this.status="INIT";const t=await this.initializePlayer();this.thisPlayer=this.onPlayerJoin(t),this.playerId=this.thisPlayer.id,this.events.GAME_INIT.dispatch(),this.appRoot.showStartDialog()}async waiting(){this.status="WAITING"}async start(){this.status!=="INIT"&&this.status!=="WAITING"||(this.savePlayerData(),await this.gameSetup(),this.gameStart(),p())}savePlayerData(){const t=this.state.playerMap.get(this.playerId);t&&(localStorage.setItem("starz_playerId",t.id),localStorage.setItem("starz_playerName",t.name),localStorage.setItem("starz_score",t.score?.score?.toString()??"0"))}async gameSetup(){const t=Array.from(this.state.playerMap.values());console.log("Setting up game with players:",t),this.state=this.game.setup(this.getFnContext()),this.events.CLEAR_MESSAGES.dispatch(),this.state.playerMap.clear();for(let e=0;e<t.length;e++){const s=t[e];this.onPlayerJoin(s),this.game.assignSystem(this.state,s.id)}this.thisPlayer=this.state.playerMap.get(this.playerId),this.setupThisPlayer(this.playerId)}async initializePlayer(){const t=this.playerId=localStorage.getItem("starz_playerId")??u(),e=localStorage.getItem("starz_playerName")??this.config.playerName,s=+(localStorage.getItem("starz_score")??0);return{id:t,name:e,score:{score:s}}}gameStart(){if(this.status!=="INIT"&&this.status!=="WAITING")return;this.events.TRACK.dispatch({eventName:"starz_gamesStarted"}),super.gameStart(),this.events.ADD_MESSAGE.dispatch("Game started.");const t=this.state.playerMap.get(this.playerId);t&&this.events.ADD_MESSAGE.dispatch(`You are ${t.name}.`)}gameStop(){super.gameStop(),h(),p()}pauseToggle(){this.isMultiplayer()||(this.status==="PAUSED"?(this.status="PLAYING",super.startGameLoop()):this.status==="PLAYING"&&(this.status="PAUSED",super.stopGameLoop()))}showEndGame(t){return this.appRoot.showEndGame(t)}async quit(){await this.showEndGame("Are you sure you want to quit?")&&this.game.eliminatePlayer(this.getFnContext(),this.playerId)}async onPlayerWin(t,e){e&&this.events.ADD_MESSAGE.dispatch(e),this.game.revealAllSystems(this.state),h();let s=!1;t===this.playerId?(this.events.TRACK.dispatch({eventName:"starz_gamesWon",meta:{winnerId:t}}),s=await this.showEndGame("You have conquered The Bubble!")):(this.events.TRACK.dispatch({eventName:"starz_gamesLost",meta:{winnerId:t}}),s=await this.showEndGame("You have lost your homeworld! Click to return to lobby.")),s&&this.restart()}restart(){this.stopGameLoop(),h(),this.tick=0,this.state=this.game.initalState(),this.connect()}onEliminatePlayer(t,e){const s=this.state.playerMap.get(t),a=this.state.playerMap.get(e),i=e===null?`${s.name} has been eliminated!`:`${a.name} has eliminated ${s.name}!`;this.events.ADD_MESSAGE.dispatch(i),t===this.playerId?(this.submitWinLoss(-1),this.onPlayerWin(e)):e===this.playerId&&this.submitWinLoss(1)}async submitWinLoss(t){const e=+(localStorage.getItem("starz_score")??0)+t;localStorage.setItem("starz_score",e.toString())}async addBot(){if(this.state.playerMap.size>=A)return;const t=Array.from(this.state.playerMap.values());if(t.filter(r=>r.bot).length>=S)return;const s=G(),a=m(t.map(r=>r.name)),i=new y({id:s});return this.onPlayerJoin({id:s,name:a,bot:i})}removeBot(t){this.state.playerMap.get(t)?.bot&&this.onPlayerLeave(t)}onPlayerJoin(t){if(t.id&&this.state.playerMap.has(t.id))return this.state.playerMap.get(t.id);const e=Array.from(this.state.playerMap.values()),s=t.id??u(),a=t.name??m(e.map(c=>c.name)),i=t.color??v(e.map(c=>c.color)),r=t.bot?new y({id:s}):void 0,l=super.addPlayer({id:s,...t,bot:r,name:a,color:i});return document.documentElement.style.setProperty(`--player-${l.id}`,l.color),this.events.PLAYER_JOINED.dispatch({player:l}),l}onPlayerLeave(t){this.state.playerMap.delete(t),this.events.PLAYER_REMOVED.dispatch({playerId:t})}setupThisPlayer(t){this.playerId=t;const e=this.state.playerMap.get(t),s=this.game.getPlayersHomeworld(this.state);this.game.visitSystem(this.state,s),P(),e.bot||(h(),M(s.id)),this.savePlayerData()}updatePlayerName(t){const e=this.state.playerMap.get(this.playerId);e&&(e.name=t,this.events.PLAYER_UPDATED.dispatch({playerId:e.id}),localStorage.setItem("starz_playerName",e.name))}#t(){this.events.PLAYER_WON.add(({playerId:t,message:e})=>{this.onPlayerWin(t,e)}),this.on("PLAYER_ELIMINATED",({loserId:t,winnerId:e})=>{this.onEliminatePlayer(t,e)}),I&&this.on("TRACK",({eventName:t,meta:e})=>{if(window&&window.sa_event)try{window.sa_event(t,{tick:this.tick,...e})}catch(s){console.error("Error tracking event:",s)}})}}export{R as LocalGameManager};
